import fs from 'node:fs/promises';
import url from 'node:url';
import util from 'node:util';
import path from 'node:path';
import slash from 'slash';
import tmp from 'tmp-promise';
import logger from '@wdio/logger';
import getPort from 'get-port';
import decamelize from 'decamelize';
import { WebSocketServer } from 'ws';
import { SevereServiceError } from 'webdriverio';
import { Workbench } from './pageobjects/index.js';
import { getLocators, getValueSuffix, isVSCodeCapability } from './utils.js';
import { VSCODE_APPLICATION_ARGS, DEFAULT_VSCODE_SETTINGS, DEFAULT_PROXY_OPTIONS, SETTINGS_KEY, VSCODE_CAPABILITY_KEY, DEFAULT_VSCODE_WEB_PORT } from './constants.js';
const log = logger('wdio-vscode-service');
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
export default class VSCodeWorkerService {
    constructor(_, _capabilities) {
        this._capabilities = _capabilities;
        this._messageId = 0;
        this._pendingMessages = new Map();
        this._isWebSession = false;
        this._isCucumberSession = false;
        this._deletingSession = false;
        this._vscodeOptions = this._capabilities[VSCODE_CAPABILITY_KEY] || {};
        this._proxyOptions = { ...DEFAULT_PROXY_OPTIONS, ...this._vscodeOptions.vscodeProxyOptions };
    }
    _handleIncoming(data) {
        try {
            const message = JSON.parse(data.toString('utf-8'));
            const resolver = this._pendingMessages.get(message.id);
            if (!resolver) {
                log.error(`Couldn't find remote message resolver with id ${message.id}`);
                return;
            }
            resolver(message.error, message.result);
        }
        catch (err) {
            log.error(`Error parsing remote response: ${err.message}`);
        }
    }
    _handleSocketClose(code, reason) {
        /*
         * Prevent this block from running when deleting a session using the Cucumber framework.
         * Otherwise the specs fail with the "Connection closed" error.
         */
        if (this._isCucumberSession && this._deletingSession) {
            return;
        }
        const msg = `Connection closed. Code: ${code}, reason: ${reason.toString()}`;
        this._promisedSocket = Promise.reject(new Error(msg));
        this._pendingMessages.forEach((resolver) => resolver(msg, null));
    }
    async beforeSession(option, capabilities) {
        this._isWebSession = capabilities.browserName !== 'vscode';
        this._isCucumberSession = option.framework === 'cucumber';
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * if we run tests for a web extension
         */
        if (this._isWebSession) {
            const serverOptions = capabilities[VSCODE_CAPABILITY_KEY]?.serverOptions;
            option.baseUrl = util.format('http://%s:%s', serverOptions?.hostname || 'localhost', (serverOptions?.port || DEFAULT_VSCODE_WEB_PORT).toString());
            log.info(`Run VSCode as web app on ${option.baseUrl}`);
            return;
        }
        const customArgs = { ...VSCODE_APPLICATION_ARGS };
        const storagePath = this._vscodeOptions.storagePath ?? (await tmp.dir()).path;
        const userSettingsPath = path.join(storagePath, 'settings', 'User');
        const userSettings = {
            ...DEFAULT_VSCODE_SETTINGS,
            ...(this._vscodeOptions.userSettings || {})
        };
        if (!this._vscodeOptions.extensionPath) {
            throw new SevereServiceError('No extension path provided');
        }
        if (this._proxyOptions.enable) {
            const port = await getPort({ port: this._proxyOptions.port });
            userSettings[SETTINGS_KEY].port = port;
            log.info(`Start VSCode proxy server on port ${port}`);
            const wss = this._wss = new WebSocketServer({ port });
            this._deletingSession = false;
            this._promisedSocket = new Promise((resolve, reject) => {
                const socketTimeout = setTimeout(() => reject(new Error('Connection timeout exceeded')), this._proxyOptions.connectionTimeout);
                wss.on('connection', (socket) => {
                    log.info('Connected with VSCode workbench');
                    this._promisedSocket = Promise.resolve(socket);
                    resolve(socket);
                    clearTimeout(socketTimeout);
                    socket.on('message', this._handleIncoming.bind(this));
                    socket.once('close', this._handleSocketClose.bind(this));
                });
            });
        }
        customArgs.extensionDevelopmentPath = slash(this._vscodeOptions.extensionPath);
        customArgs.extensionTestsPath = slash(path.join(__dirname, 'proxy', 'cjs', 'entry.js'));
        customArgs.userDataDir = slash(path.join(storagePath, 'settings'));
        customArgs.extensionsDir = slash(path.join(storagePath, 'extensions'));
        customArgs.vscodeBinaryPath = this._vscodeOptions.binary;
        log.info(`Setting up VSCode directory at ${userSettingsPath}`);
        await fs.mkdir(userSettingsPath, { recursive: true });
        await fs.writeFile(path.join(userSettingsPath, 'settings.json'), JSON.stringify(userSettings), 'utf-8');
        if (this._vscodeOptions.workspacePath) {
            customArgs.folderUri = `file:${slash(this._vscodeOptions.workspacePath)}`;
        }
        if (this._vscodeOptions.filePath) {
            customArgs.fileUri = `file:${slash(this._vscodeOptions.filePath)}`;
        }
        if (this._vscodeOptions.verboseLogging) {
            customArgs.verbose = true;
            customArgs.logExtensionHostCommunication = true;
        }
        const binary = path.join(__dirname, 'chromium', `index.${process.platform === 'win32' ? 'exe' : 'js'}`);
        const args = Object.entries({ ...customArgs, ...this._vscodeOptions.vscodeArgs }).reduce((prev, [key, value]) => {
            const decamelizedKey = decamelize(key, { separator: '-' });
            if (Array.isArray(value)) {
                const expandedArgs = value.map((val) => `--${decamelizedKey}${getValueSuffix(val)}`);
                return [...prev, ...expandedArgs];
            }
            return [...prev, `--${decamelizedKey}${getValueSuffix(value)}`];
        }, []);
        /**
         * need to rename capability back to Chrome otherwise Chromedriver
         * won't recognise this capability
         */
        capabilities.browserName = 'chrome';
        capabilities['goog:chromeOptions'] = { binary, args, windowTypes: ['webview'] };
        log.info(`Start VSCode: ${binary} ${args.join(' ')}`);
    }
    beforeCommand(commandName) {
        if (commandName === 'deleteSession') {
            this._deletingSession = true;
        }
    }
    async before(capabilities, __, browser) {
        /**
         * only run setup for VSCode capabilities
         */
        if (!isVSCodeCapability(capabilities)) {
            return;
        }
        /**
         * open VSCode web when testing web extensions
         */
        if (this._isWebSession) {
            await browser.url('/');
        }
        this._browser = browser;
        const locators = await getLocators(capabilities.browserVersion || 'insiders');
        const workbenchPO = new Workbench(locators);
        this._browser.addCommand('getWorkbench', () => workbenchPO.wait());
        this._browser.addCommand('executeWorkbench', this._executeVSCode.bind(this));
        this._browser.addCommand('getVSCodeVersion', () => capabilities.browserVersion);
        this._browser.addCommand('isVSCodeWebSession', () => this._isWebSession);
        this._browser.addCommand('getVSCodeChannel', () => (capabilities.browserVersion === 'insiders' ? 'insiders' : 'vscode'));
        await workbenchPO.elem.waitForExist();
        /**
         * VSCode in the browser doesn't allow to have a file directly opened,
         * therefore we need to open it automatically
         */
        if (this._isWebSession && this._vscodeOptions.filePath && this._vscodeOptions.workspacePath) {
            const sections = this._vscodeOptions.filePath.replace(this._vscodeOptions.workspacePath, '')
                .split(path.sep).filter(Boolean);
            const fileExplorer = await browser.$('.explorer-folders-view');
            while (sections.length > 0) {
                const entry = sections.shift();
                await fileExplorer.$(`span=${entry}`).click();
            }
        }
    }
    async after() {
        if (!isVSCodeCapability(this._capabilities)
            || !this._browser
            || !this._capabilities[VSCODE_CAPABILITY_KEY]?.verboseLogging) {
            return;
        }
        const logs = await this._browser.getLogs('browser').then((res) => res, (err) => err);
        if (logs instanceof Error) {
            return;
        }
        for (const l of logs) {
            log.info(`[${(new Date(l.timestamp)).toISOString()}]`
                + ` - ${l.source} - ${l.message}`);
        }
        if (this._wss) {
            this._wss.close();
        }
    }
    async _executeVSCode(fn, ...params) {
        if (!this._promisedSocket || this._isWebSession) {
            const errorMessage = this._isWebSession
                ? 'not support when testing web extensions'
                : 'see "vscodeProxyOptions" option in service docs';
            throw new Error(`VSCode API proxy not enabled, ${errorMessage}`);
        }
        const socket = await this._promisedSocket;
        const proxyFn = typeof fn === 'function'
            ? fn.toString()
            : fn;
        socket.send(JSON.stringify({
            id: this._messageId,
            fn: proxyFn,
            params
        }));
        const returnVal = new Promise((resolve, reject) => {
            const cmdTimeout = setTimeout(() => reject(new Error('Remote command timeout exceeded')), this._proxyOptions.commandTimeout);
            this._pendingMessages.set(this._messageId, (error, result) => {
                clearTimeout(cmdTimeout);
                if (error) {
                    reject(new Error(error));
                    return;
                }
                resolve(result);
            });
        });
        this._messageId += 1;
        return returnVal;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQTtBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFDNUIsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFBO0FBQzVCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUE7QUFDN0IsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQTtBQUM5QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUE7QUFDbkMsT0FBTyxFQUFFLGVBQWUsRUFBYSxNQUFNLElBQUksQ0FBQTtBQUUvQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFFaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzVFLE9BQU8sRUFDSCx1QkFBdUIsRUFBRSx1QkFBdUIsRUFBRSxxQkFBcUIsRUFDdkUsWUFBWSxFQUFFLHFCQUFxQixFQUFFLHVCQUF1QixFQUMvRCxNQUFNLGdCQUFnQixDQUFBO0FBTXZCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNsRSxNQUFNLENBQUMsT0FBTyxPQUFPLG1CQUFtQjtJQVlwQyxZQUFhLENBQVEsRUFBVSxhQUFpQztRQUFqQyxr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QUFPO1lBQ1gsTUFBTTtTQUNULENBQUMsQ0FBQyxDQUFBO1FBRUgsTUFBTSxTQUFTLEdBQUcsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDOUMsTUFBTSxVQUFVLEdBQUcsVUFBVSxDQUN6QixHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQyxFQUMxRCxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FDcEMsQ0FBQTtZQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLEtBQXlCLEVBQUUsTUFBVyxFQUFFLEVBQUU7Z0JBQ2xGLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQTtnQkFDeEIsSUFBSSxLQUFLLEVBQUUsQ0FBQztvQkFDUixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtvQkFDeEIsT0FBTTtnQkFDVixDQUFDO2dCQUNELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNuQixDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUE7UUFDcEIsT0FBTyxTQUFTLENBQUE7SUFDcEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ25vZGU6ZnMvcHJvbWlzZXMnXG5pbXBvcnQgdXJsIGZyb20gJ25vZGU6dXJsJ1xuaW1wb3J0IHV0aWwgZnJvbSAnbm9kZTp1dGlsJ1xuaW1wb3J0IHBhdGggZnJvbSAnbm9kZTpwYXRoJ1xuaW1wb3J0IHNsYXNoIGZyb20gJ3NsYXNoJ1xuaW1wb3J0IHRtcCBmcm9tICd0bXAtcHJvbWlzZSdcbmltcG9ydCBsb2dnZXIgZnJvbSAnQHdkaW8vbG9nZ2VyJ1xuaW1wb3J0IGdldFBvcnQgZnJvbSAnZ2V0LXBvcnQnXG5pbXBvcnQgZGVjYW1lbGl6ZSBmcm9tICdkZWNhbWVsaXplJ1xuaW1wb3J0IHsgV2ViU29ja2V0U2VydmVyLCBXZWJTb2NrZXQgfSBmcm9tICd3cydcbmltcG9ydCB7IFNlcnZpY2VzLCBPcHRpb25zIH0gZnJvbSAnQHdkaW8vdHlwZXMnXG5pbXBvcnQgeyBTZXZlcmVTZXJ2aWNlRXJyb3IgfSBmcm9tICd3ZWJkcml2ZXJpbydcblxuaW1wb3J0IHsgV29ya2JlbmNoIH0gZnJvbSAnLi9wYWdlb2JqZWN0cy9pbmRleC5qcydcbmltcG9ydCB7IGdldExvY2F0b3JzLCBnZXRWYWx1ZVN1ZmZpeCwgaXNWU0NvZGVDYXBhYmlsaXR5IH0gZnJvbSAnLi91dGlscy5qcydcbmltcG9ydCB7XG4gICAgVlNDT0RFX0FQUExJQ0FUSU9OX0FSR1MsIERFRkFVTFRfVlNDT0RFX1NFVFRJTkdTLCBERUZBVUxUX1BST1hZX09QVElPTlMsXG4gICAgU0VUVElOR1NfS0VZLCBWU0NPREVfQ0FQQUJJTElUWV9LRVksIERFRkFVTFRfVlNDT0RFX1dFQl9QT1JUXG59IGZyb20gJy4vY29uc3RhbnRzLmpzJ1xuaW1wb3J0IHR5cGUge1xuICAgIFZTQ29kZUNhcGFiaWxpdGllcywgV0RJT0xvZ3MsIEFyZ3NQYXJhbXMsIFJlbW90ZUNvbW1hbmQsIFJlbW90ZVJlc3BvbnNlLFxuICAgIFBlbmRpbmdNZXNzYWdlUmVzb2x2ZXIsIFZTQ29kZVByb3h5T3B0aW9ucywgVlNDb2RlT3B0aW9uc1xufSBmcm9tICcuL3R5cGVzLmpzJ1xuXG5jb25zdCBsb2cgPSBsb2dnZXIoJ3dkaW8tdnNjb2RlLXNlcnZpY2UnKVxuY29uc3QgX19kaXJuYW1lID0gdXJsLmZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLicsIGltcG9ydC5tZXRhLnVybCkpXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWU0NvZGVXb3JrZXJTZXJ2aWNlIGltcGxlbWVudHMgU2VydmljZXMuU2VydmljZUluc3RhbmNlIHtcbiAgICBwcml2YXRlIF9icm93c2VyPzogV2ViZHJpdmVySU8uQnJvd3NlclxuICAgIHByaXZhdGUgX3dzcz86IFdlYlNvY2tldFNlcnZlclxuICAgIHByaXZhdGUgX21lc3NhZ2VJZCA9IDBcbiAgICBwcml2YXRlIF9wZW5kaW5nTWVzc2FnZXMgPSBuZXcgTWFwPG51bWJlciwgUGVuZGluZ01lc3NhZ2VSZXNvbHZlcj4oKVxuICAgIHByaXZhdGUgX3Byb21pc2VkU29ja2V0PzogUHJvbWlzZTxXZWJTb2NrZXQ+XG4gICAgcHJpdmF0ZSBfcHJveHlPcHRpb25zOiBWU0NvZGVQcm94eU9wdGlvbnNcbiAgICBwcml2YXRlIF92c2NvZGVPcHRpb25zOiBWU0NvZGVPcHRpb25zXG4gICAgcHJpdmF0ZSBfaXNXZWJTZXNzaW9uID0gZmFsc2VcbiAgICBwcml2YXRlIF9pc0N1Y3VtYmVyU2Vzc2lvbiA9IGZhbHNlXG4gICAgcHJpdmF0ZSBfZGVsZXRpbmdTZXNzaW9uID0gZmFsc2VcblxuICAgIGNvbnN0cnVjdG9yIChfOiBuZXZlciwgcHJpdmF0ZSBfY2FwYWJpbGl0aWVzOiBWU0NvZGVDYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgdGhpcy5fdnNjb2RlT3B0aW9ucyA9IHRoaXMuX2NhcGFiaWxpdGllc1tWU0NPREVfQ0FQQUJJTElUWV9LRVldIHx8IDxWU0NvZGVPcHRpb25zPnt9XG4gICAgICAgIHRoaXMuX3Byb3h5T3B0aW9ucyA9IHsgLi4uREVGQVVMVF9QUk9YWV9PUFRJT05TLCAuLi50aGlzLl92c2NvZGVPcHRpb25zLnZzY29kZVByb3h5T3B0aW9ucyB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlSW5jb21pbmcgKGRhdGE6IEJ1ZmZlcikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygndXRmLTgnKSkgYXMgUmVtb3RlUmVzcG9uc2VcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVyID0gdGhpcy5fcGVuZGluZ01lc3NhZ2VzLmdldChtZXNzYWdlLmlkKVxuXG4gICAgICAgICAgICBpZiAoIXJlc29sdmVyKSB7XG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKGBDb3VsZG4ndCBmaW5kIHJlbW90ZSBtZXNzYWdlIHJlc29sdmVyIHdpdGggaWQgJHttZXNzYWdlLmlkfWApXG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc29sdmVyKG1lc3NhZ2UuZXJyb3IsIG1lc3NhZ2UucmVzdWx0KVxuICAgICAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgICAgICAgbG9nLmVycm9yKGBFcnJvciBwYXJzaW5nIHJlbW90ZSByZXNwb25zZTogJHtlcnIubWVzc2FnZX1gKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlU29ja2V0Q2xvc2UgKGNvZGU6IG51bWJlciwgcmVhc29uOiBCdWZmZXIpIHtcbiAgICAgICAgLypcbiAgICAgICAgICogUHJldmVudCB0aGlzIGJsb2NrIGZyb20gcnVubmluZyB3aGVuIGRlbGV0aW5nIGEgc2Vzc2lvbiB1c2luZyB0aGUgQ3VjdW1iZXIgZnJhbWV3b3JrLlxuICAgICAgICAgKiBPdGhlcndpc2UgdGhlIHNwZWNzIGZhaWwgd2l0aCB0aGUgXCJDb25uZWN0aW9uIGNsb3NlZFwiIGVycm9yLlxuICAgICAgICAgKi9cbiAgICAgICAgaWYgKHRoaXMuX2lzQ3VjdW1iZXJTZXNzaW9uICYmIHRoaXMuX2RlbGV0aW5nU2Vzc2lvbikge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtc2cgPSBgQ29ubmVjdGlvbiBjbG9zZWQuIENvZGU6ICR7Y29kZX0sIHJlYXNvbjogJHtyZWFzb24udG9TdHJpbmcoKX1gXG4gICAgICAgIHRoaXMuX3Byb21pc2VkU29ja2V0ID0gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKG1zZykpXG4gICAgICAgIHRoaXMuX3BlbmRpbmdNZXNzYWdlcy5mb3JFYWNoKChyZXNvbHZlcikgPT4gcmVzb2x2ZXIobXNnLCBudWxsKSlcbiAgICB9XG5cbiAgICBhc3luYyBiZWZvcmVTZXNzaW9uIChvcHRpb246IE9wdGlvbnMuVGVzdHJ1bm5lciwgY2FwYWJpbGl0aWVzOiBWU0NvZGVDYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgdGhpcy5faXNXZWJTZXNzaW9uID0gY2FwYWJpbGl0aWVzLmJyb3dzZXJOYW1lICE9PSAndnNjb2RlJ1xuICAgICAgICB0aGlzLl9pc0N1Y3VtYmVyU2Vzc2lvbiA9IG9wdGlvbi5mcmFtZXdvcmsgPT09ICdjdWN1bWJlcidcblxuICAgICAgICAvKipcbiAgICAgICAgICogb25seSBydW4gc2V0dXAgZm9yIFZTQ29kZSBjYXBhYmlsaXRpZXNcbiAgICAgICAgICovXG4gICAgICAgIGlmICghaXNWU0NvZGVDYXBhYmlsaXR5KGNhcGFiaWxpdGllcykpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGlmIHdlIHJ1biB0ZXN0cyBmb3IgYSB3ZWIgZXh0ZW5zaW9uXG4gICAgICAgICAqL1xuICAgICAgICBpZiAodGhpcy5faXNXZWJTZXNzaW9uKSB7XG4gICAgICAgICAgICBjb25zdCBzZXJ2ZXJPcHRpb25zID0gY2FwYWJpbGl0aWVzW1ZTQ09ERV9DQVBBQklMSVRZX0tFWV0/LnNlcnZlck9wdGlvbnNcbiAgICAgICAgICAgIG9wdGlvbi5iYXNlVXJsID0gdXRpbC5mb3JtYXQoXG4gICAgICAgICAgICAgICAgJ2h0dHA6Ly8lczolcycsXG4gICAgICAgICAgICAgICAgc2VydmVyT3B0aW9ucz8uaG9zdG5hbWUgfHwgJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgICAgICAgKHNlcnZlck9wdGlvbnM/LnBvcnQgfHwgREVGQVVMVF9WU0NPREVfV0VCX1BPUlQgYXMgbnVtYmVyKS50b1N0cmluZygpXG4gICAgICAgICAgICApXG4gICAgICAgICAgICBsb2cuaW5mbyhgUnVuIFZTQ29kZSBhcyB3ZWIgYXBwIG9uICR7b3B0aW9uLmJhc2VVcmx9YClcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3VzdG9tQXJnczogQXJnc1BhcmFtcyA9IHsgLi4uVlNDT0RFX0FQUExJQ0FUSU9OX0FSR1MgfVxuICAgICAgICBjb25zdCBzdG9yYWdlUGF0aCA9IHRoaXMuX3ZzY29kZU9wdGlvbnMuc3RvcmFnZVBhdGggPz8gKGF3YWl0IHRtcC5kaXIoKSkucGF0aFxuICAgICAgICBjb25zdCB1c2VyU2V0dGluZ3NQYXRoID0gcGF0aC5qb2luKHN0b3JhZ2VQYXRoLCAnc2V0dGluZ3MnLCAnVXNlcicpXG4gICAgICAgIGNvbnN0IHVzZXJTZXR0aW5nczogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICAgICAgICAgIC4uLkRFRkFVTFRfVlNDT0RFX1NFVFRJTkdTLFxuICAgICAgICAgICAgLi4uKHRoaXMuX3ZzY29kZU9wdGlvbnMudXNlclNldHRpbmdzIHx8IHt9KVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLl92c2NvZGVPcHRpb25zLmV4dGVuc2lvblBhdGgpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBTZXZlcmVTZXJ2aWNlRXJyb3IoJ05vIGV4dGVuc2lvbiBwYXRoIHByb3ZpZGVkJylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLl9wcm94eU9wdGlvbnMuZW5hYmxlKSB7XG4gICAgICAgICAgICBjb25zdCBwb3J0ID0gYXdhaXQgZ2V0UG9ydCh7IHBvcnQ6IHRoaXMuX3Byb3h5T3B0aW9ucy5wb3J0IH0pXG4gICAgICAgICAgICB1c2VyU2V0dGluZ3NbU0VUVElOR1NfS0VZXS5wb3J0ID0gcG9ydFxuICAgICAgICAgICAgbG9nLmluZm8oYFN0YXJ0IFZTQ29kZSBwcm94eSBzZXJ2ZXIgb24gcG9ydCAke3BvcnR9YClcbiAgICAgICAgICAgIGNvbnN0IHdzcyA9IHRoaXMuX3dzcyA9IG5ldyBXZWJTb2NrZXRTZXJ2ZXIoeyBwb3J0IH0pXG4gICAgICAgICAgICB0aGlzLl9kZWxldGluZ1Nlc3Npb24gPSBmYWxzZVxuICAgICAgICAgICAgdGhpcy5fcHJvbWlzZWRTb2NrZXQgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc29ja2V0VGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHJlamVjdChuZXcgRXJyb3IoJ0Nvbm5lY3Rpb24gdGltZW91dCBleGNlZWRlZCcpKSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJveHlPcHRpb25zLmNvbm5lY3Rpb25UaW1lb3V0XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIHdzcy5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oJ0Nvbm5lY3RlZCB3aXRoIFZTQ29kZSB3b3JrYmVuY2gnKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9taXNlZFNvY2tldCA9IFByb21pc2UucmVzb2x2ZShzb2NrZXQpXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoc29ja2V0KVxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoc29ja2V0VGltZW91dClcbiAgICAgICAgICAgICAgICAgICAgc29ja2V0Lm9uKCdtZXNzYWdlJywgdGhpcy5faGFuZGxlSW5jb21pbmcuYmluZCh0aGlzKSlcbiAgICAgICAgICAgICAgICAgICAgc29ja2V0Lm9uY2UoJ2Nsb3NlJywgdGhpcy5faGFuZGxlU29ja2V0Q2xvc2UuYmluZCh0aGlzKSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGN1c3RvbUFyZ3MuZXh0ZW5zaW9uRGV2ZWxvcG1lbnRQYXRoID0gc2xhc2godGhpcy5fdnNjb2RlT3B0aW9ucy5leHRlbnNpb25QYXRoKVxuICAgICAgICBjdXN0b21BcmdzLmV4dGVuc2lvblRlc3RzUGF0aCA9IHNsYXNoKHBhdGguam9pbihfX2Rpcm5hbWUsICdwcm94eScsICdjanMnLCAnZW50cnkuanMnKSlcbiAgICAgICAgY3VzdG9tQXJncy51c2VyRGF0YURpciA9IHNsYXNoKHBhdGguam9pbihzdG9yYWdlUGF0aCwgJ3NldHRpbmdzJykpXG4gICAgICAgIGN1c3RvbUFyZ3MuZXh0ZW5zaW9uc0RpciA9IHNsYXNoKHBhdGguam9pbihzdG9yYWdlUGF0aCwgJ2V4dGVuc2lvbnMnKSlcbiAgICAgICAgY3VzdG9tQXJncy52c2NvZGVCaW5hcnlQYXRoID0gdGhpcy5fdnNjb2RlT3B0aW9ucy5iaW5hcnkgYXMgc3RyaW5nXG5cbiAgICAgICAgbG9nLmluZm8oYFNldHRpbmcgdXAgVlNDb2RlIGRpcmVjdG9yeSBhdCAke3VzZXJTZXR0aW5nc1BhdGh9YClcbiAgICAgICAgYXdhaXQgZnMubWtkaXIodXNlclNldHRpbmdzUGF0aCwgeyByZWN1cnNpdmU6IHRydWUgfSlcbiAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKFxuICAgICAgICAgICAgcGF0aC5qb2luKHVzZXJTZXR0aW5nc1BhdGgsICdzZXR0aW5ncy5qc29uJyksXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh1c2VyU2V0dGluZ3MpLFxuICAgICAgICAgICAgJ3V0Zi04J1xuICAgICAgICApXG5cbiAgICAgICAgaWYgKHRoaXMuX3ZzY29kZU9wdGlvbnMud29ya3NwYWNlUGF0aCkge1xuICAgICAgICAgICAgY3VzdG9tQXJncy5mb2xkZXJVcmkgPSBgZmlsZToke3NsYXNoKHRoaXMuX3ZzY29kZU9wdGlvbnMud29ya3NwYWNlUGF0aCl9YFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX3ZzY29kZU9wdGlvbnMuZmlsZVBhdGgpIHtcbiAgICAgICAgICAgIGN1c3RvbUFyZ3MuZmlsZVVyaSA9IGBmaWxlOiR7c2xhc2godGhpcy5fdnNjb2RlT3B0aW9ucy5maWxlUGF0aCl9YFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX3ZzY29kZU9wdGlvbnMudmVyYm9zZUxvZ2dpbmcpIHtcbiAgICAgICAgICAgIGN1c3RvbUFyZ3MudmVyYm9zZSA9IHRydWVcbiAgICAgICAgICAgIGN1c3RvbUFyZ3MubG9nRXh0ZW5zaW9uSG9zdENvbW11bmljYXRpb24gPSB0cnVlXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBiaW5hcnkgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnY2hyb21pdW0nLCBgaW5kZXguJHtwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gJ2V4ZScgOiAnanMnfWApXG4gICAgICAgIGNvbnN0IGFyZ3MgPSBPYmplY3QuZW50cmllcyh7IC4uLmN1c3RvbUFyZ3MsIC4uLnRoaXMuX3ZzY29kZU9wdGlvbnMudnNjb2RlQXJncyB9KS5yZWR1Y2UoXG4gICAgICAgICAgICAocHJldiwgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVjYW1lbGl6ZWRLZXkgPSBkZWNhbWVsaXplKGtleSwgeyBzZXBhcmF0b3I6ICctJyB9KVxuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBleHBhbmRlZEFyZ3MgPSB2YWx1ZS5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAodmFsKSA9PiBgLS0ke2RlY2FtZWxpemVkS2V5fSR7Z2V0VmFsdWVTdWZmaXgodmFsKX1gXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsuLi5wcmV2LCAuLi5leHBhbmRlZEFyZ3NdXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIFsuLi5wcmV2LCBgLS0ke2RlY2FtZWxpemVkS2V5fSR7Z2V0VmFsdWVTdWZmaXgodmFsdWUpfWBdXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgW10gYXMgc3RyaW5nW11cbiAgICAgICAgKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBuZWVkIHRvIHJlbmFtZSBjYXBhYmlsaXR5IGJhY2sgdG8gQ2hyb21lIG90aGVyd2lzZSBDaHJvbWVkcml2ZXJcbiAgICAgICAgICogd29uJ3QgcmVjb2duaXNlIHRoaXMgY2FwYWJpbGl0eVxuICAgICAgICAgKi9cbiAgICAgICAgY2FwYWJpbGl0aWVzLmJyb3dzZXJOYW1lID0gJ2Nocm9tZSdcbiAgICAgICAgY2FwYWJpbGl0aWVzWydnb29nOmNocm9tZU9wdGlvbnMnXSA9IHsgYmluYXJ5LCBhcmdzLCB3aW5kb3dUeXBlczogWyd3ZWJ2aWV3J10gfVxuICAgICAgICBsb2cuaW5mbyhgU3RhcnQgVlNDb2RlOiAke2JpbmFyeX0gJHthcmdzLmpvaW4oJyAnKX1gKVxuICAgIH1cblxuICAgIGJlZm9yZUNvbW1hbmQgKGNvbW1hbmROYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKGNvbW1hbmROYW1lID09PSAnZGVsZXRlU2Vzc2lvbicpIHtcbiAgICAgICAgICAgIHRoaXMuX2RlbGV0aW5nU2Vzc2lvbiA9IHRydWVcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGJlZm9yZSAoY2FwYWJpbGl0aWVzOiBWU0NvZGVDYXBhYmlsaXRpZXMsIF9fOiBuZXZlciwgYnJvd3NlcjogV2ViZHJpdmVySU8uQnJvd3Nlcikge1xuICAgICAgICAvKipcbiAgICAgICAgICogb25seSBydW4gc2V0dXAgZm9yIFZTQ29kZSBjYXBhYmlsaXRpZXNcbiAgICAgICAgICovXG4gICAgICAgIGlmICghaXNWU0NvZGVDYXBhYmlsaXR5KGNhcGFiaWxpdGllcykpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIG9wZW4gVlNDb2RlIHdlYiB3aGVuIHRlc3Rpbmcgd2ViIGV4dGVuc2lvbnNcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLl9pc1dlYlNlc3Npb24pIHtcbiAgICAgICAgICAgIGF3YWl0IGJyb3dzZXIudXJsKCcvJylcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIgPSBicm93c2VyXG4gICAgICAgIGNvbnN0IGxvY2F0b3JzID0gYXdhaXQgZ2V0TG9jYXRvcnMoY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uIHx8ICdpbnNpZGVycycpXG4gICAgICAgIGNvbnN0IHdvcmtiZW5jaFBPID0gbmV3IFdvcmtiZW5jaChsb2NhdG9ycylcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdnZXRXb3JrYmVuY2gnLCAoKSA9PiB3b3JrYmVuY2hQTy53YWl0KCkpXG4gICAgICAgIHRoaXMuX2Jyb3dzZXIuYWRkQ29tbWFuZCgnZXhlY3V0ZVdvcmtiZW5jaCcsIHRoaXMuX2V4ZWN1dGVWU0NvZGUuYmluZCh0aGlzKSlcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdnZXRWU0NvZGVWZXJzaW9uJywgKCkgPT4gY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uKVxuICAgICAgICB0aGlzLl9icm93c2VyLmFkZENvbW1hbmQoJ2lzVlNDb2RlV2ViU2Vzc2lvbicsICgpID0+IHRoaXMuX2lzV2ViU2Vzc2lvbilcbiAgICAgICAgdGhpcy5fYnJvd3Nlci5hZGRDb21tYW5kKCdnZXRWU0NvZGVDaGFubmVsJywgKCkgPT4gKFxuICAgICAgICAgICAgY2FwYWJpbGl0aWVzLmJyb3dzZXJWZXJzaW9uID09PSAnaW5zaWRlcnMnID8gJ2luc2lkZXJzJyA6ICd2c2NvZGUnXG4gICAgICAgICkpXG4gICAgICAgIGF3YWl0IHdvcmtiZW5jaFBPLmVsZW0ud2FpdEZvckV4aXN0KClcblxuICAgICAgICAvKipcbiAgICAgICAgICogVlNDb2RlIGluIHRoZSBicm93c2VyIGRvZXNuJ3QgYWxsb3cgdG8gaGF2ZSBhIGZpbGUgZGlyZWN0bHkgb3BlbmVkLFxuICAgICAgICAgKiB0aGVyZWZvcmUgd2UgbmVlZCB0byBvcGVuIGl0IGF1dG9tYXRpY2FsbHlcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLl9pc1dlYlNlc3Npb24gJiYgdGhpcy5fdnNjb2RlT3B0aW9ucy5maWxlUGF0aCAmJiB0aGlzLl92c2NvZGVPcHRpb25zLndvcmtzcGFjZVBhdGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHNlY3Rpb25zID0gdGhpcy5fdnNjb2RlT3B0aW9ucy5maWxlUGF0aC5yZXBsYWNlKHRoaXMuX3ZzY29kZU9wdGlvbnMud29ya3NwYWNlUGF0aCwgJycpXG4gICAgICAgICAgICAgICAgLnNwbGl0KHBhdGguc2VwKS5maWx0ZXIoQm9vbGVhbilcbiAgICAgICAgICAgIGNvbnN0IGZpbGVFeHBsb3JlciA9IGF3YWl0IGJyb3dzZXIuJCgnLmV4cGxvcmVyLWZvbGRlcnMtdmlldycpXG4gICAgICAgICAgICB3aGlsZSAoc2VjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gc2VjdGlvbnMuc2hpZnQoKVxuICAgICAgICAgICAgICAgIGF3YWl0IGZpbGVFeHBsb3Jlci4kKGBzcGFuPSR7ZW50cnl9YCkuY2xpY2soKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgYWZ0ZXIgKCkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAhaXNWU0NvZGVDYXBhYmlsaXR5KHRoaXMuX2NhcGFiaWxpdGllcylcbiAgICAgICAgICAgIHx8ICF0aGlzLl9icm93c2VyXG4gICAgICAgICAgICB8fCAhdGhpcy5fY2FwYWJpbGl0aWVzW1ZTQ09ERV9DQVBBQklMSVRZX0tFWV0/LnZlcmJvc2VMb2dnaW5nXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsb2dzID0gYXdhaXQgdGhpcy5fYnJvd3Nlci5nZXRMb2dzKCdicm93c2VyJykudGhlbihcbiAgICAgICAgICAgIChyZXMpID0+IHJlcyBhcyBXRElPTG9nc1tdLFxuICAgICAgICAgICAgKGVycikgPT4gZXJyIGFzIEVycm9yXG4gICAgICAgIClcblxuICAgICAgICBpZiAobG9ncyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgbCBvZiBsb2dzKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhcbiAgICAgICAgICAgICAgICBgWyR7KG5ldyBEYXRlKGwudGltZXN0YW1wKSkudG9JU09TdHJpbmcoKX1dYFxuICAgICAgICAgICAgICAgICsgYCAtICR7bC5zb3VyY2V9IC0gJHtsLm1lc3NhZ2V9YFxuICAgICAgICAgICAgKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX3dzcykge1xuICAgICAgICAgICAgdGhpcy5fd3NzLmNsb3NlKClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2V4ZWN1dGVWU0NvZGUgKGZuOiBGdW5jdGlvbiB8IHN0cmluZywgLi4ucGFyYW1zOiBhbnlbXSkge1xuICAgICAgICBpZiAoIXRoaXMuX3Byb21pc2VkU29ja2V0IHx8IHRoaXMuX2lzV2ViU2Vzc2lvbikge1xuICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gdGhpcy5faXNXZWJTZXNzaW9uXG4gICAgICAgICAgICAgICAgPyAnbm90IHN1cHBvcnQgd2hlbiB0ZXN0aW5nIHdlYiBleHRlbnNpb25zJ1xuICAgICAgICAgICAgICAgIDogJ3NlZSBcInZzY29kZVByb3h5T3B0aW9uc1wiIG9wdGlvbiBpbiBzZXJ2aWNlIGRvY3MnXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZTQ29kZSBBUEkgcHJveHkgbm90IGVuYWJsZWQsICR7ZXJyb3JNZXNzYWdlfWApXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzb2NrZXQgPSBhd2FpdCB0aGlzLl9wcm9taXNlZFNvY2tldFxuXG4gICAgICAgIGNvbnN0IHByb3h5Rm4gPSB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgID8gZm4udG9TdHJpbmcoKVxuICAgICAgICAgICAgOiBmblxuXG4gICAgICAgIHNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KDxSZW1vdGVDb21tYW5kPntcbiAgICAgICAgICAgIGlkOiB0aGlzLl9tZXNzYWdlSWQsXG4gICAgICAgICAgICBmbjogcHJveHlGbixcbiAgICAgICAgICAgIHBhcmFtc1xuICAgICAgICB9KSlcblxuICAgICAgICBjb25zdCByZXR1cm5WYWwgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjbWRUaW1lb3V0ID0gc2V0VGltZW91dChcbiAgICAgICAgICAgICAgICAoKSA9PiByZWplY3QobmV3IEVycm9yKCdSZW1vdGUgY29tbWFuZCB0aW1lb3V0IGV4Y2VlZGVkJykpLFxuICAgICAgICAgICAgICAgIHRoaXMuX3Byb3h5T3B0aW9ucy5jb21tYW5kVGltZW91dFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgdGhpcy5fcGVuZGluZ01lc3NhZ2VzLnNldCh0aGlzLl9tZXNzYWdlSWQsIChlcnJvcjogc3RyaW5nIHwgdW5kZWZpbmVkLCByZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChjbWRUaW1lb3V0KVxuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5fbWVzc2FnZUlkICs9IDFcbiAgICAgICAgcmV0dXJuIHJldHVyblZhbFxuICAgIH1cbn1cblxuaW50ZXJmYWNlIFZTQ29kZUNvbW1hbmRzIHtcbiAgICBnZXRXb3JrYmVuY2g6ICgpID0+IFByb21pc2U8V29ya2JlbmNoPlxuICAgIC8vIFRvZG8oQ2hyaXN0aWFuKTogcHJvcGVybHkgdHlwZSBWU0NvZGUgb2JqZWN0IGhlcmVcbiAgICBleGVjdXRlV29ya2JlbmNoOiA8VD4oZm46ICh2c2NvZGU6IGFueSwgLi4ucGFyYW1zOiBhbnlbXSkgPT4gVCwgLi4ucGFyYW1zOiBhbnlbXSkgPT4gUHJvbWlzZTxUPlxuICAgIGdldFZTQ29kZVZlcnNpb246ICgpID0+IFByb21pc2U8c3RyaW5nPlxuICAgIGdldFZTQ29kZUNoYW5uZWw6ICgpID0+IFByb21pc2U8c3RyaW5nPlxuICAgIGlzVlNDb2RlV2ViU2Vzc2lvbjogKCkgPT4gUHJvbWlzZTxib29sZWFuPlxufVxuXG5kZWNsYXJlIGdsb2JhbCB7XG4gICAgbmFtZXNwYWNlIFdlYmRyaXZlcklPIHtcbiAgICAgICAgaW50ZXJmYWNlIEJyb3dzZXIgZXh0ZW5kcyBWU0NvZGVDb21tYW5kcyB7fVxuICAgIH1cblxuICAgIG5hbWVzcGFjZSBXZWJkcml2ZXJJT0FzeW5jIHtcbiAgICAgICAgaW50ZXJmYWNlIEJyb3dzZXIgZXh0ZW5kcyBWU0NvZGVDb21tYW5kcyB7fVxuICAgICAgICBpbnRlcmZhY2UgTXVsdGlSZW1vdGVCcm93c2VyIGV4dGVuZHMgVlNDb2RlQ29tbWFuZHMgeyB9XG4gICAgfVxufVxuIl19