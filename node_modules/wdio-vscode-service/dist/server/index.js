import fs from 'node:fs/promises';
import url from 'node:url';
import path from 'node:path';
import logger from '@wdio/logger';
import getPort from 'get-port';
import fastify from 'fastify';
import fastifyCors from '@fastify/cors';
import fastifyStatic from '@fastify/static';
import { request } from 'undici';
import getWorkbench from './workbench.tpl.js';
import { getWorkbenchOptions } from './utils.js';
import { getFileType } from '../utils.js';
import { fsProviderExtensionPrefix } from './constants.js';
import { DEFAULT_VSCODE_WEB_PORT, DEFAULT_CHANNEL, DEFAULT_VSCODE_WEB_HOSTNAME } from '../constants.js';
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
const log = logger('wdio-vscode-service/server');
const mountPrefix = '/static/mount';
const webviewHostRegexp = /^https:\/\/[^.]+\.vscode-webview\.net$/;
/**
 * ToDo(Christian): missing capabilities:
 *   - allow serve VSCode sources from path location or CDN
 *   - allow to include additional extensions (#20)
 */
export default async function startServer(standalone, options) {
    const app = fastify({ logger: true });
    const port = await getPort({ port: options.serverOptions?.port || DEFAULT_VSCODE_WEB_PORT });
    await app.register(fastifyCors, {
        methods: ['GET'],
        credentials: true,
        origin: (origin, cb) => cb(null, webviewHostRegexp.test(origin || ''))
    });
    app.addHook('preHandler', async (req, reply) => {
        // eslint-disable-next-line @typescript-eslint/no-floating-promises
        reply.header('Access-Control-Allow-Origin', '*');
        const value = req.query['vscode-coi'];
        if (value === '1') {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Opener-Policy', 'same-origin');
        }
        else if (value === '2') {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Embedder-Policy', 'require-corp');
        }
        else if (value === '3' || value === '') {
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Opener-Policy', 'same-origin');
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            reply.header('Cross-Origin-Embedder-Policy', 'require-corp');
        }
    });
    if (options.extensionPath) {
        log.info(`Serving dev extensions from ${options.extensionPath}`);
        await app.register(fastifyStatic, {
            prefix: '/static/devextensions',
            root: options.extensionPath
        });
    }
    await app.register(fastifyStatic, {
        prefix: '/static/build',
        root: standalone.path,
        decorateReply: false // the reply decorator has been added by the first plugin registration
    });
    if (options.workspacePath) {
        log.info(`Serve workspace from ${options.workspacePath}`);
        app.addHook('preHandler', async (req, reply) => {
            const filePath = req.params['*'];
            const queries = Object.keys(req.query);
            if (!options.workspacePath || !filePath || !req.url.startsWith(mountPrefix)) {
                return null;
            }
            const p = path.join(options.workspacePath, filePath === mountPrefix.slice(1)
                ? filePath.slice(mountPrefix.length - 1)
                : filePath);
            if (queries.includes('stat')) {
                try {
                    const stats = await fs.stat(p);
                    // eslint-disable-next-line @typescript-eslint/return-await
                    return reply.send(JSON.stringify({
                        type: getFileType(stats),
                        ctime: stats.ctime.getTime(),
                        mtime: stats.mtime.getTime(),
                        size: stats.size
                    }));
                }
                catch (e) {
                    log.warn(e.stack);
                    return reply.send(JSON.stringify({
                        error: e.code
                    }));
                }
            }
            if (queries.includes('readdir')) {
                try {
                    const entries = await fs.readdir(p, { withFileTypes: true });
                    // eslint-disable-next-line @typescript-eslint/return-await
                    return reply.send(JSON.stringify(entries.map((d) => ({ name: d.name, type: getFileType(d) }))));
                }
                catch (e) {
                    log.warn(e.stack);
                    return reply.send(JSON.stringify({
                        error: e.code
                    }));
                }
            }
            return null;
        });
        await app.register(fastifyStatic, {
            prefix: `${mountPrefix}/`,
            root: options.workspacePath,
            dotfiles: 'allow',
            decorateReply: false // the reply decorator has been added by the first plugin registration
        });
        await app.register(fastifyStatic, {
            prefix: fsProviderExtensionPrefix,
            root: path.join(__dirname, '..', '..', 'src', 'server', 'fs-provider'),
            decorateReply: false // the reply decorator has been added by the first plugin registration
        });
    }
    /**
     * mount additional extensions here, e.g.:
     * ```
     * if (config.extensionPaths) {
     *   config.extensionPaths.forEach((extensionPath, index) => {
     *     console.log('Serving additional built-in extensions from ' + extensionPath);
     *     app.use(kmount(`/static/extensions/${index}`, kstatic(extensionPath, serveOptions)));
     *   });
     * }
     * ```
     * when working on https://github.com/webdriverio-community/wdio-vscode-service/issues/20
     */
    /**
     * Workbench
     */
    app.get('/callback', async (req, reply) => {
        const host = `${req.protocol}://${req.hostname || DEFAULT_VSCODE_WEB_HOSTNAME}:${port}`;
        const cbUrl = `${host}/${req.url}/out/vs/code/browser/workbench/callback.html`;
        const { body } = await request(cbUrl, {});
        await reply.send(body);
    });
    app.get('/', async (req, reply) => {
        const hostname = req.hostname || DEFAULT_VSCODE_WEB_HOSTNAME;
        const host = `${req.protocol}://${hostname}`;
        const webConfiguration = await getWorkbenchOptions({ protocol: req.protocol, host: hostname }, {
            /**
             * modify when support additional extension
             */
            extensionPaths: [],
            extensionIds: [], // GalleryExtensionInfo[] | undefined
            extensionDevelopmentPath: options.extensionPath,
            build: {
                type: 'static',
                location: standalone.path,
                quality: (options.version || DEFAULT_CHANNEL),
                version: standalone.version
            },
            extensionTestsPath: undefined,
            folderUri: undefined,
            folderMountPath: options.workspacePath,
            printServerLog: true
        });
        const template = getWorkbench({
            baseUrl: `${host}/static/build`,
            webConfiguration: JSON.stringify(webConfiguration).replace(/"/g, '&quot;'),
            authSession: '',
            builtinExtensions: '[]'
        });
        // eslint-disable-next-line @typescript-eslint/no-floating-promises
        reply.header('Content-Type', 'text/html');
        return reply.send(template);
    });
    await app.listen(port);
    log.info(`VSCode server started on port ${port}`);
    return port;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pDLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQTtBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUE7QUFFNUIsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFBO0FBQ2pDLE9BQU8sT0FBTyxNQUFNLFVBQVUsQ0FBQTtBQUM5QixPQUFPLE9BQTJCLE1BQU0sU0FBUyxDQUFBO0FBQ2pELE9BQU8sV0FBVyxNQUFNLGVBQWUsQ0FBQTtBQUN2QyxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBRWhDLE9BQU8sWUFBWSxNQUFNLG9CQUFvQixDQUFBO0FBQzdDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFBO0FBQ3pDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQzFELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxlQUFlLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUd2RyxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDbEUsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLDRCQUE0QixDQUFDLENBQUE7QUFFaEQsTUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFBO0FBQ25DLE1BQU0saUJBQWlCLEdBQUcsd0NBQXdDLENBQUE7QUFRbEU7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxVQUFV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LENBQUMsSUFBSTtnQkFDekIsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxlQUFlLENBQXlCO2dCQUNyRSxPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87YUFDOUI7WUFDRCxrQkFBa0IsRUFBRSxTQUFTO1lBQzdCLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLGVBQWUsRUFBRSxPQUFPLENBQUMsYUFBYTtZQUN0QyxjQUFjLEVBQUUsSUFBSTtTQUN2QixDQUNKLENBQUE7UUFFRCxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUM7WUFDMUIsT0FBTyxFQUFFLEdBQUcsSUFBSSxlQUFlO1lBQy9CLGdCQUFnQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQztZQUMxRSxXQUFXLEVBQUUsRUFBRTtZQUNmLGlCQUFpQixFQUFFLElBQUk7U0FDMUIsQ0FBQyxDQUFBO1FBRUYsbUVBQW1FO1FBQ25FLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLFdBQVcsQ0FBQyxDQUFBO1FBQ3pDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMvQixDQUFDLENBQUMsQ0FBQTtJQUVGLE1BQU0sR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN0QixHQUFHLENBQUMsSUFBSSxDQUFDLGlDQUFpQyxJQUFJLEVBQUUsQ0FBQyxDQUFBO0lBQ2pELE9BQU8sSUFBSSxDQUFBO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdub2RlOmZzL3Byb21pc2VzJ1xuaW1wb3J0IHVybCBmcm9tICdub2RlOnVybCdcbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCdcblxuaW1wb3J0IGxvZ2dlciBmcm9tICdAd2Rpby9sb2dnZXInXG5pbXBvcnQgZ2V0UG9ydCBmcm9tICdnZXQtcG9ydCdcbmltcG9ydCBmYXN0aWZ5LCB7IEZhc3RpZnlSZXF1ZXN0IH0gZnJvbSAnZmFzdGlmeSdcbmltcG9ydCBmYXN0aWZ5Q29ycyBmcm9tICdAZmFzdGlmeS9jb3JzJ1xuaW1wb3J0IGZhc3RpZnlTdGF0aWMgZnJvbSAnQGZhc3RpZnkvc3RhdGljJ1xuaW1wb3J0IHsgcmVxdWVzdCB9IGZyb20gJ3VuZGljaSdcblxuaW1wb3J0IGdldFdvcmtiZW5jaCBmcm9tICcuL3dvcmtiZW5jaC50cGwuanMnXG5pbXBvcnQgeyBnZXRXb3JrYmVuY2hPcHRpb25zIH0gZnJvbSAnLi91dGlscy5qcydcbmltcG9ydCB7IGdldEZpbGVUeXBlIH0gZnJvbSAnLi4vdXRpbHMuanMnXG5pbXBvcnQgeyBmc1Byb3ZpZGVyRXh0ZW5zaW9uUHJlZml4IH0gZnJvbSAnLi9jb25zdGFudHMuanMnXG5pbXBvcnQgeyBERUZBVUxUX1ZTQ09ERV9XRUJfUE9SVCwgREVGQVVMVF9DSEFOTkVMLCBERUZBVUxUX1ZTQ09ERV9XRUJfSE9TVE5BTUUgfSBmcm9tICcuLi9jb25zdGFudHMuanMnXG5pbXBvcnQgdHlwZSB7IFZTQ29kZU9wdGlvbnMsIEJ1bmRsZSB9IGZyb20gJy4uL3R5cGVzLmpzJ1xuXG5jb25zdCBfX2Rpcm5hbWUgPSB1cmwuZmlsZVVSTFRvUGF0aChuZXcgVVJMKCcuJywgaW1wb3J0Lm1ldGEudXJsKSlcbmNvbnN0IGxvZyA9IGxvZ2dlcignd2Rpby12c2NvZGUtc2VydmljZS9zZXJ2ZXInKVxuXG5jb25zdCBtb3VudFByZWZpeCA9ICcvc3RhdGljL21vdW50J1xuY29uc3Qgd2Vidmlld0hvc3RSZWdleHAgPSAvXmh0dHBzOlxcL1xcL1teLl0rXFwudnNjb2RlLXdlYnZpZXdcXC5uZXQkL1xuXG50eXBlIENPSVJlcXVlc3QgPSBGYXN0aWZ5UmVxdWVzdDx7XG4gICAgUXVlcnlzdHJpbmc6IHtcbiAgICAgICAgJ3ZzY29kZS1jb2knOiAnMScgfCAnMicgfCAnMydcbiAgICB9XG59PlxuXG4vKipcbiAqIFRvRG8oQ2hyaXN0aWFuKTogbWlzc2luZyBjYXBhYmlsaXRpZXM6XG4gKiAgIC0gYWxsb3cgc2VydmUgVlNDb2RlIHNvdXJjZXMgZnJvbSBwYXRoIGxvY2F0aW9uIG9yIENETlxuICogICAtIGFsbG93IHRvIGluY2x1ZGUgYWRkaXRpb25hbCBleHRlbnNpb25zICgjMjApXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyIChzdGFuZGFsb25lOiBCdW5kbGUsIG9wdGlvbnM6IFZTQ29kZU9wdGlvbnMpIHtcbiAgICBjb25zdCBhcHAgPSBmYXN0aWZ5KHsgbG9nZ2VyOiB0cnVlIH0pXG4gICAgY29uc3QgcG9ydCA9IGF3YWl0IGdldFBvcnQoeyBwb3J0OiBvcHRpb25zLnNlcnZlck9wdGlvbnM/LnBvcnQgfHwgREVGQVVMVF9WU0NPREVfV0VCX1BPUlQgfSlcbiAgICBhd2FpdCBhcHAucmVnaXN0ZXIoZmFzdGlmeUNvcnMsIHtcbiAgICAgICAgbWV0aG9kczogWydHRVQnXSxcbiAgICAgICAgY3JlZGVudGlhbHM6IHRydWUsXG4gICAgICAgIG9yaWdpbjogKG9yaWdpbiwgY2IpID0+IGNiKG51bGwsIHdlYnZpZXdIb3N0UmVnZXhwLnRlc3Qob3JpZ2luIHx8ICcnKSlcbiAgICB9KVxuXG4gICAgYXBwLmFkZEhvb2soJ3ByZUhhbmRsZXInLCBhc3luYyAocmVxOiBDT0lSZXF1ZXN0LCByZXBseSkgPT4ge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgIHJlcGx5LmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKVxuXG4gICAgICAgIGNvbnN0IHZhbHVlID0gcmVxLnF1ZXJ5Wyd2c2NvZGUtY29pJ11cbiAgICAgICAgaWYgKHZhbHVlID09PSAnMScpIHtcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgICAgIHJlcGx5LmhlYWRlcignQ3Jvc3MtT3JpZ2luLU9wZW5lci1Qb2xpY3knLCAnc2FtZS1vcmlnaW4nKVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnMicpIHtcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgICAgIHJlcGx5LmhlYWRlcignQ3Jvc3MtT3JpZ2luLUVtYmVkZGVyLVBvbGljeScsICdyZXF1aXJlLWNvcnAnKVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnMycgfHwgdmFsdWUgPT09ICcnKSB7XG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgICAgICByZXBseS5oZWFkZXIoJ0Nyb3NzLU9yaWdpbi1PcGVuZXItUG9saWN5JywgJ3NhbWUtb3JpZ2luJylcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgICAgIHJlcGx5LmhlYWRlcignQ3Jvc3MtT3JpZ2luLUVtYmVkZGVyLVBvbGljeScsICdyZXF1aXJlLWNvcnAnKVxuICAgICAgICB9XG4gICAgfSlcblxuICAgIGlmIChvcHRpb25zLmV4dGVuc2lvblBhdGgpIHtcbiAgICAgICAgbG9nLmluZm8oYFNlcnZpbmcgZGV2IGV4dGVuc2lvbnMgZnJvbSAke29wdGlvbnMuZXh0ZW5zaW9uUGF0aH1gKVxuICAgICAgICBhd2FpdCBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgICAgICAgICAgcHJlZml4OiAnL3N0YXRpYy9kZXZleHRlbnNpb25zJyxcbiAgICAgICAgICAgIHJvb3Q6IG9wdGlvbnMuZXh0ZW5zaW9uUGF0aFxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGF3YWl0IGFwcC5yZWdpc3RlcihmYXN0aWZ5U3RhdGljLCB7XG4gICAgICAgIHByZWZpeDogJy9zdGF0aWMvYnVpbGQnLFxuICAgICAgICByb290OiBzdGFuZGFsb25lLnBhdGgsXG4gICAgICAgIGRlY29yYXRlUmVwbHk6IGZhbHNlIC8vIHRoZSByZXBseSBkZWNvcmF0b3IgaGFzIGJlZW4gYWRkZWQgYnkgdGhlIGZpcnN0IHBsdWdpbiByZWdpc3RyYXRpb25cbiAgICB9KVxuXG4gICAgaWYgKG9wdGlvbnMud29ya3NwYWNlUGF0aCkge1xuICAgICAgICBsb2cuaW5mbyhgU2VydmUgd29ya3NwYWNlIGZyb20gJHtvcHRpb25zLndvcmtzcGFjZVBhdGh9YClcbiAgICAgICAgYXBwLmFkZEhvb2soJ3ByZUhhbmRsZXInLCBhc3luYyAocmVxLCByZXBseSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmlsZVBhdGggPSAocmVxLnBhcmFtcyBhcyB7ICcqJzogc3RyaW5nIH0pWycqJ11cbiAgICAgICAgICAgIGNvbnN0IHF1ZXJpZXMgPSBPYmplY3Qua2V5cyhyZXEucXVlcnkgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPilcblxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLndvcmtzcGFjZVBhdGggfHwgIWZpbGVQYXRoIHx8ICFyZXEudXJsLnN0YXJ0c1dpdGgobW91bnRQcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcCA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICBvcHRpb25zLndvcmtzcGFjZVBhdGgsXG4gICAgICAgICAgICAgICAgZmlsZVBhdGggPT09IG1vdW50UHJlZml4LnNsaWNlKDEpXG4gICAgICAgICAgICAgICAgICAgID8gZmlsZVBhdGguc2xpY2UobW91bnRQcmVmaXgubGVuZ3RoIC0gMSlcbiAgICAgICAgICAgICAgICAgICAgOiBmaWxlUGF0aFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgaWYgKHF1ZXJpZXMuaW5jbHVkZXMoJ3N0YXQnKSkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgZnMuc3RhdChwKVxuICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L3JldHVybi1hd2FpdFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVwbHkuc2VuZChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBnZXRGaWxlVHlwZShzdGF0cyksXG4gICAgICAgICAgICAgICAgICAgICAgICBjdGltZTogc3RhdHMuY3RpbWUuZ2V0VGltZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbXRpbWU6IHN0YXRzLm10aW1lLmdldFRpbWUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IHN0YXRzLnNpemVcbiAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKGUuc3RhY2spXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXBseS5zZW5kKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAoZSBhcyBOb2RlSlMuRXJybm9FeGNlcHRpb24pLmNvZGVcbiAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocXVlcmllcy5pbmNsdWRlcygncmVhZGRpcicpKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW50cmllcyA9IGF3YWl0IGZzLnJlYWRkaXIocCwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pXG4gICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvcmV0dXJuLWF3YWl0XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXBseS5zZW5kKEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgICAgICAgICAgZW50cmllcy5tYXAoKGQpID0+ICh7IG5hbWU6IGQubmFtZSwgdHlwZTogZ2V0RmlsZVR5cGUoZCkgfSkpXG4gICAgICAgICAgICAgICAgICAgICkpXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy53YXJuKGUuc3RhY2spXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXBseS5zZW5kKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAoZSBhcyBOb2RlSlMuRXJybm9FeGNlcHRpb24pLmNvZGVcbiAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICB9KVxuXG4gICAgICAgIGF3YWl0IGFwcC5yZWdpc3RlcihmYXN0aWZ5U3RhdGljLCB7XG4gICAgICAgICAgICBwcmVmaXg6IGAke21vdW50UHJlZml4fS9gLFxuICAgICAgICAgICAgcm9vdDogb3B0aW9ucy53b3Jrc3BhY2VQYXRoLFxuICAgICAgICAgICAgZG90ZmlsZXM6ICdhbGxvdycsXG4gICAgICAgICAgICBkZWNvcmF0ZVJlcGx5OiBmYWxzZSAvLyB0aGUgcmVwbHkgZGVjb3JhdG9yIGhhcyBiZWVuIGFkZGVkIGJ5IHRoZSBmaXJzdCBwbHVnaW4gcmVnaXN0cmF0aW9uXG4gICAgICAgIH0pXG4gICAgICAgIGF3YWl0IGFwcC5yZWdpc3RlcihmYXN0aWZ5U3RhdGljLCB7XG4gICAgICAgICAgICBwcmVmaXg6IGZzUHJvdmlkZXJFeHRlbnNpb25QcmVmaXgsXG4gICAgICAgICAgICByb290OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnc3JjJywgJ3NlcnZlcicsICdmcy1wcm92aWRlcicpLFxuICAgICAgICAgICAgZGVjb3JhdGVSZXBseTogZmFsc2UgLy8gdGhlIHJlcGx5IGRlY29yYXRvciBoYXMgYmVlbiBhZGRlZCBieSB0aGUgZmlyc3QgcGx1Z2luIHJlZ2lzdHJhdGlvblxuICAgICAgICB9KVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIG1vdW50IGFkZGl0aW9uYWwgZXh0ZW5zaW9ucyBoZXJlLCBlLmcuOlxuICAgICAqIGBgYFxuICAgICAqIGlmIChjb25maWcuZXh0ZW5zaW9uUGF0aHMpIHtcbiAgICAgKiAgIGNvbmZpZy5leHRlbnNpb25QYXRocy5mb3JFYWNoKChleHRlbnNpb25QYXRoLCBpbmRleCkgPT4ge1xuICAgICAqICAgICBjb25zb2xlLmxvZygnU2VydmluZyBhZGRpdGlvbmFsIGJ1aWx0LWluIGV4dGVuc2lvbnMgZnJvbSAnICsgZXh0ZW5zaW9uUGF0aCk7XG4gICAgICogICAgIGFwcC51c2Uoa21vdW50KGAvc3RhdGljL2V4dGVuc2lvbnMvJHtpbmRleH1gLCBrc3RhdGljKGV4dGVuc2lvblBhdGgsIHNlcnZlT3B0aW9ucykpKTtcbiAgICAgKiAgIH0pO1xuICAgICAqIH1cbiAgICAgKiBgYGBcbiAgICAgKiB3aGVuIHdvcmtpbmcgb24gaHR0cHM6Ly9naXRodWIuY29tL3dlYmRyaXZlcmlvLWNvbW11bml0eS93ZGlvLXZzY29kZS1zZXJ2aWNlL2lzc3Vlcy8yMFxuICAgICAqL1xuXG4gICAgLyoqXG4gICAgICogV29ya2JlbmNoXG4gICAgICovXG4gICAgYXBwLmdldCgnL2NhbGxiYWNrJywgYXN5bmMgKHJlcSwgcmVwbHkpID0+IHtcbiAgICAgICAgY29uc3QgaG9zdCA9IGAke3JlcS5wcm90b2NvbH06Ly8ke3JlcS5ob3N0bmFtZSB8fCBERUZBVUxUX1ZTQ09ERV9XRUJfSE9TVE5BTUV9OiR7cG9ydH1gXG4gICAgICAgIGNvbnN0IGNiVXJsID0gYCR7aG9zdH0vJHtyZXEudXJsfS9vdXQvdnMvY29kZS9icm93c2VyL3dvcmtiZW5jaC9jYWxsYmFjay5odG1sYFxuICAgICAgICBjb25zdCB7IGJvZHkgfSA9IGF3YWl0IHJlcXVlc3QoY2JVcmwsIHt9KVxuICAgICAgICBhd2FpdCByZXBseS5zZW5kKGJvZHkpXG4gICAgfSlcblxuICAgIGFwcC5nZXQoJy8nLCBhc3luYyAocmVxLCByZXBseSkgPT4ge1xuICAgICAgICBjb25zdCBob3N0bmFtZSA9IHJlcS5ob3N0bmFtZSB8fCBERUZBVUxUX1ZTQ09ERV9XRUJfSE9TVE5BTUVcbiAgICAgICAgY29uc3QgaG9zdCA9IGAke3JlcS5wcm90b2NvbH06Ly8ke2hvc3RuYW1lfWBcbiAgICAgICAgY29uc3Qgd2ViQ29uZmlndXJhdGlvbiA9IGF3YWl0IGdldFdvcmtiZW5jaE9wdGlvbnMoXG4gICAgICAgICAgICB7IHByb3RvY29sOiByZXEucHJvdG9jb2wsIGhvc3Q6IGhvc3RuYW1lIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogbW9kaWZ5IHdoZW4gc3VwcG9ydCBhZGRpdGlvbmFsIGV4dGVuc2lvblxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGV4dGVuc2lvblBhdGhzOiBbXSxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25JZHM6IFtdLCAvLyBHYWxsZXJ5RXh0ZW5zaW9uSW5mb1tdIHwgdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgZXh0ZW5zaW9uRGV2ZWxvcG1lbnRQYXRoOiBvcHRpb25zLmV4dGVuc2lvblBhdGgsXG4gICAgICAgICAgICAgICAgYnVpbGQ6IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3N0YXRpYycgYXMgY29uc3QsXG4gICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiBzdGFuZGFsb25lLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgIHF1YWxpdHk6IChvcHRpb25zLnZlcnNpb24gfHwgREVGQVVMVF9DSEFOTkVMKSBhcyAnc3RhYmxlJyB8ICdpbnNpZGVyJyxcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogc3RhbmRhbG9uZS52ZXJzaW9uXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25UZXN0c1BhdGg6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBmb2xkZXJVcmk6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBmb2xkZXJNb3VudFBhdGg6IG9wdGlvbnMud29ya3NwYWNlUGF0aCxcbiAgICAgICAgICAgICAgICBwcmludFNlcnZlckxvZzogdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICApXG5cbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBnZXRXb3JrYmVuY2goe1xuICAgICAgICAgICAgYmFzZVVybDogYCR7aG9zdH0vc3RhdGljL2J1aWxkYCxcbiAgICAgICAgICAgIHdlYkNvbmZpZ3VyYXRpb246IEpTT04uc3RyaW5naWZ5KHdlYkNvbmZpZ3VyYXRpb24pLnJlcGxhY2UoL1wiL2csICcmcXVvdDsnKSxcbiAgICAgICAgICAgIGF1dGhTZXNzaW9uOiAnJyxcbiAgICAgICAgICAgIGJ1aWx0aW5FeHRlbnNpb25zOiAnW10nXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgICByZXBseS5oZWFkZXIoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L2h0bWwnKVxuICAgICAgICByZXR1cm4gcmVwbHkuc2VuZCh0ZW1wbGF0ZSlcbiAgICB9KVxuXG4gICAgYXdhaXQgYXBwLmxpc3Rlbihwb3J0KVxuICAgIGxvZy5pbmZvKGBWU0NvZGUgc2VydmVyIHN0YXJ0ZWQgb24gcG9ydCAke3BvcnR9YClcbiAgICByZXR1cm4gcG9ydFxufVxuIl19