import { ContextMenu } from './index.js';
export function PageDecorator(locators) {
    return (ctor) => {
        for (const [prop, globalLocator] of Object.entries(locators)) {
            Object.defineProperties(ctor.prototype, {
                [`${prop}$`]: {
                    get: function () {
                        const locator = this.locators[prop] || globalLocator;
                        if (typeof locator === 'function') {
                            return (...args) => this.elem.$(locator(...args));
                        }
                        return this.elem.$(locator);
                    }
                },
                [`${prop}$$`]: {
                    get: function () {
                        const locator = this.locators[prop] || globalLocator;
                        if (typeof locator === 'function') {
                            return (...args) => this.elem.$$(locator(...args));
                        }
                        return this.elem.$$(locator);
                    }
                }
            });
        }
        Object.seal(ctor);
        Object.seal(ctor.prototype);
        return ctor;
    };
}
export class BasePage {
    /**
     * @private
     */
    constructor(_locators, _baseElem, _parentElem) {
        this._locators = _locators;
        this._baseElem = _baseElem;
        this._parentElem = _parentElem;
    }
    /**
     * Get the locator map of given page object
     */
    get locators() {
        if (Array.isArray(this.locatorKey)) {
            return this.locatorKey.reduce((prev, locatorKey) => ({
                ...prev,
                ...this._locators[locatorKey]
            }), {});
        }
        return this._locators[this.locatorKey];
    }
    /**
     * @private
     */
    get baseElem() {
        return this._baseElem;
    }
    /**
     * @private
     */
    get locatorMap() {
        return this._locators;
    }
    /**
     * Base element of given page object
     */
    get elem() {
        const baseLocator = this.locators.elem;
        if (this._baseElem) {
            return typeof this._baseElem === 'string'
                ? browser.$(this._baseElem)
                : this._baseElem;
        }
        if (typeof baseLocator === 'string') {
            return browser.$(baseLocator);
        }
        return browser.$('html');
    }
    /**
     * Parent element of given page object
     */
    get parent() {
        if (this._parentElem) {
            return typeof this._parentElem === 'string'
                ? browser.$(this._parentElem)
                : this._parentElem;
        }
        return browser.$('html');
    }
    /**
     * @private
     */
    setParentElement(parentElem) {
        this._parentElem = parentElem;
    }
    /**
     * Wait for the element to become visible
     * @param timeout custom timeout for the wait
     * @returns thenable self reference
     */
    async wait(timeout = 5000) {
        await this.elem.waitForDisplayed({ timeout });
        return this;
    }
    /**
     * Poll for the element to become visible
     * @param timeout custom timeout for the wait
     * @param interval custom interval to control polling
     * @returns thenable self reference
     */
    async poll(timeout = 10000, interval = 2000) {
        await this.elem.waitForDisplayed({ timeout, interval });
        return this;
    }
}
/**
 * Abstract element that has a context menu
 */
export class ElementWithContextMenu extends BasePage {
    /**
     * Open context menu on the element
     */
    async openContextMenu() {
        const contextMenuLocators = this.locatorMap.ContextMenu;
        const workbench = browser.$(this.locatorMap.Workbench.elem);
        const menus = await browser.$$(contextMenuLocators.contextView);
        if (menus.length < 1) {
            await this.elem.click({ button: 2 });
            await browser.$(contextMenuLocators.contextView).waitForExist({ timeout: 2000 });
            return new ContextMenu(this.locatorMap, workbench).wait();
        }
        if (await workbench.$$(contextMenuLocators.viewBlock).length > 0) {
            await this.elem.click({ button: 2 });
            await this.elem.waitForDisplayed({ reverse: true, timeout: 1000 });
        }
        await this.elem.click({ button: 2 });
        return new ContextMenu(this.locatorMap).wait();
    }
}
export function sleep(ms = 500) {
    return new Promise((res) => {
        setTimeout(res, ms);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcGFnZW9iamVjdHMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQW9EeEMsTUFBTSxVQUFVLGFBQWEsQ0FBNkIsUUFBa0I7SUFDeEUsT0FBTyxDQUFDLElBQU8sRUFBRSxFQUFFO1FBQ2YsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUMzRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDcEMsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUU7b0JBQ1YsR0FBRyxFQUFFO3dCQUNELE1BQU0sT0FBTyxHQUFxQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLGFBQWEsQ0FBQTt3QkFDdEUsSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUUsQ0FBQzs0QkFDaEMsT0FBTyxDQUFDLEdBQUcsSUFBYyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQVcsQ0FBQyxDQUFBO3dCQUN6RSxDQUFDO3dCQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUE7b0JBQy9CLENBQUM7aUJBQ0o7Z0JBQ0QsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUU7b0JBQ1gsR0FBRyxFQUFFO3dCQUNELE1BQU0sT0FBTyxHQUFxQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLGFBQWEsQ0FBQTt3QkFDdEUsSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUUsQ0FBQzs0QkFDaEMsT0FBTyxDQUFDLEdBQUcsSUFBYyxFQUFF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QUMsU0FBUyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQy9ELE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUNwQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1FBQ3RFLENBQUM7UUFFRCxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDcEMsT0FBTyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDbEQsQ0FBQztDQUNKO0FBRUQsTUFBTSxVQUFVLEtBQUssQ0FBRSxFQUFFLEdBQUcsR0FBRztJQUMzQixPQUFPLElBQUksT0FBTyxDQUFPLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDN0IsVUFBVSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUN2QixDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBvYmplY3Qtc2hvcnRoYW5kICovXG5pbXBvcnQgdHlwZSB7IENoYWluYWJsZVByb21pc2VFbGVtZW50LCBDaGFpbmFibGVQcm9taXNlQXJyYXkgfSBmcm9tICd3ZWJkcml2ZXJpbydcblxuaW1wb3J0ICogYXMgYWxsTG9jYXRvcnNUeXBlcyBmcm9tICcuLi9sb2NhdG9ycy9pbnNpZGVycy5qcydcbmltcG9ydCB7IENvbnRleHRNZW51IH0gZnJvbSAnLi9pbmRleC5qcydcblxudHlwZSBDbGFzc1dpdGhGdW5jdGlvbkxvY2F0b3JzQXNTdHJpbmc8VD4gPSB7XG4gICAgW2tleSBpbiBrZXlvZiBUIGFzIFRba2V5XSBleHRlbmRzIEZ1bmN0aW9uIHwgdW5kZWZpbmVkID8ga2V5IDogbmV2ZXJdOiBUW2tleV1cbn1cblxudHlwZSBDbGFzc1dpdGhGdW5jdGlvbkxvY2F0b3JzJDxUPiA9IHtcbiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRoaXMgZmFpbHMgY29tcGlsaW5nIGhlcmUgYnV0IHdvcmtzIHdoZW4gYXBwbGllZCB0byBhIGNsYXNzXG4gICAgW2tleSBpbiBrZXlvZiBDbGFzc1dpdGhGdW5jdGlvbkxvY2F0b3JzQXNTdHJpbmc8VD4gYXMgYCR7a2V5fSRgXTogKFxuICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRoaXMgZmFpbHMgY29tcGlsaW5nIGhlcmUgYnV0IHdvcmtzIHdoZW4gYXBwbGllZCB0byBhIGNsYXNzXG4gICAgICAgIC4uLmFyZ3M6IFBhcmFtZXRlcnM8Q2xhc3NXaXRoRnVuY3Rpb25Mb2NhdG9yc0FzU3RyaW5nPFQ+W2tleV0+XG4gICAgKSA9PiBDaGFpbmFibGVQcm9taXNlRWxlbWVudDxXZWJkcml2ZXJJTy5FbGVtZW50PlxufVxuXG50eXBlIENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnMkJDxUPiA9IHtcbiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRoaXMgZmFpbHMgY29tcGlsaW5nIGhlcmUgYnV0IHdvcmtzIHdoZW4gYXBwbGllZCB0byBhIGNsYXNzXG4gICAgW2tleSBpbiBrZXlvZiBDbGFzc1dpdGhGdW5jdGlvbkxvY2F0b3JzQXNTdHJpbmc8VD4gYXMgYCR7a2V5fSQkYF06IChcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0aGlzIGZhaWxzIGNvbXBpbGluZyBoZXJlIGJ1dCB3b3JrcyB3aGVuIGFwcGxpZWQgdG8gYSBjbGFzc1xuICAgICAgICAuLi5hcmdzOiBQYXJhbWV0ZXJzPENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnNBc1N0cmluZzxUPltrZXldPlxuICAgICkgPT4gQ2hhaW5hYmxlUHJvbWlzZUFycmF5PFdlYmRyaXZlcklPLkVsZW1lbnRbXT5cbn1cblxudHlwZSBDbGFzc1dpdGhMb2NhdG9ycyQ8VD4gPSB7XG4gICAgW2tleSBpbiBrZXlvZiBUICYgc3RyaW5nIGFzIFRba2V5XSBleHRlbmRzIFN0cmluZyB8IHVuZGVmaW5lZFxuICAgICAgICA/IGAke2tleX0kYFxuICAgICAgICA6IG5ldmVyXTogQ2hhaW5hYmxlUHJvbWlzZUVsZW1lbnQ8V2ViZHJpdmVySU8uRWxlbWVudD5cbn1cbnR5cGUgQ2xhc3NXaXRoTG9jYXRvcnMkJDxUPiA9IHtcbiAgICBba2V5IGluIGtleW9mIFQgJiBzdHJpbmcgYXMgVFtrZXldIGV4dGVuZHMgU3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgICAgID8gYCR7a2V5fSQkYFxuICAgICAgICA6IG5ldmVyXTogQ2hhaW5hYmxlUHJvbWlzZUFycmF5PFdlYmRyaXZlcklPLkVsZW1lbnRbXT5cbn1cblxudHlwZSBMb2NhdG9yUHJvcGVydGllczxUPiA9IHtcbiAgICByZWFkb25seSBsb2NhdG9yTWFwOiBBbGxMb2NhdG9yVHlwZSxcbiAgICByZWFkb25seSBsb2NhdG9yczogVFxufVxuXG50eXBlIEFsbExvY2F0b3JUeXBlID0gdHlwZW9mIGFsbExvY2F0b3JzVHlwZXNcbmV4cG9ydCB0eXBlIExvY2F0b3JDb21wb25lbnRzID0ga2V5b2YgQWxsTG9jYXRvclR5cGUgfCAoa2V5b2YgQWxsTG9jYXRvclR5cGUpW11cbmV4cG9ydCB0eXBlIExvY2F0b3JzID0gUmVjb3JkPHN0cmluZyB8IHN5bWJvbCwgc3RyaW5nIHwgRnVuY3Rpb24+XG5leHBvcnQgdHlwZSBWU0NvZGVMb2NhdG9yTWFwID0gUmVjb3JkPGtleW9mIEFsbExvY2F0b3JUeXBlLCBMb2NhdG9ycz5cbmV4cG9ydCB0eXBlIElQYWdlRGVjb3JhdG9yPFQ+ID0gKFxuICAgIENsYXNzV2l0aExvY2F0b3JzJDxUPiAmIENsYXNzV2l0aExvY2F0b3JzJCQ8VD4gJlxuICAgIENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnMkPFQ+ICYgQ2xhc3NXaXRoRnVuY3Rpb25Mb2NhdG9ycyQkPFQ+XG4pXG5cbnR5cGUgUGFnZU9iamVjdENsYXNzID0ge1xuICAgIG5ldyguLi5hcmdzOiBhbnlbXSk6IGFueVxuICAgIFtzdGF0aWNNZXRob2Q6IHN0cmluZ106IGFueVxufVxuXG5leHBvcnQgZnVuY3Rpb24gUGFnZURlY29yYXRvcjxUIGV4dGVuZHMgUGFnZU9iamVjdENsYXNzPiAobG9jYXRvcnM6IExvY2F0b3JzKSB7XG4gICAgcmV0dXJuIChjdG9yOiBUKSA9PiB7XG4gICAgICAgIGZvciAoY29uc3QgW3Byb3AsIGdsb2JhbExvY2F0b3JdIG9mIE9iamVjdC5lbnRyaWVzKGxvY2F0b3JzKSkge1xuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY3Rvci5wcm90b3R5cGUsIHtcbiAgICAgICAgICAgICAgICBbYCR7cHJvcH0kYF06IHtcbiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAodGhpczogTG9jYXRvclByb3BlcnRpZXM8YW55PiAmIEJhc2VQYWdlPGFueT4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0b3I6IExvY2F0b3JzW3N0cmluZ10gPSB0aGlzLmxvY2F0b3JzW3Byb3BdIHx8IGdsb2JhbExvY2F0b3JcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbG9jYXRvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoLi4uYXJnczogc3RyaW5nW10pID0+IHRoaXMuZWxlbS4kKGxvY2F0b3IoLi4uYXJncykgYXMgc3RyaW5nKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWxlbS4kKGxvY2F0b3IpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIFtgJHtwcm9wfSQkYF06IHtcbiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAodGhpczogTG9jYXRvclByb3BlcnRpZXM8YW55PiAmIEJhc2VQYWdlPGFueT4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0b3I6IExvY2F0b3JzW3N0cmluZ10gPSB0aGlzLmxvY2F0b3JzW3Byb3BdIHx8IGdsb2JhbExvY2F0b3JcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbG9jYXRvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoLi4uYXJnczogc3RyaW5nW10pID0+IHRoaXMuZWxlbS4kJChsb2NhdG9yKC4uLmFyZ3MpIGFzIHN0cmluZylcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVsZW0uJCQobG9jYXRvcilcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3Quc2VhbChjdG9yKVxuICAgICAgICBPYmplY3Quc2VhbChjdG9yLnByb3RvdHlwZSlcbiAgICAgICAgcmV0dXJuIGN0b3JcbiAgICB9XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBCYXNlUGFnZTxQYWdlTG9jYXRvcnMsIExvY2F0b3JNYXAgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBMb2NhdG9ycz4gPSBWU0NvZGVMb2NhdG9yTWFwPiB7XG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhYnN0cmFjdCBsb2NhdG9yS2V5OiBrZXlvZiBMb2NhdG9yTWFwIHwgKGtleW9mIExvY2F0b3JNYXApW11cblxuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgY29uc3RydWN0b3IgKFxuICAgICAgICBwcm90ZWN0ZWQgX2xvY2F0b3JzOiBMb2NhdG9yTWFwLFxuICAgICAgICBwcml2YXRlIF9iYXNlRWxlbT86IHN0cmluZyB8IENoYWluYWJsZVByb21pc2VFbGVtZW50PFdlYmRyaXZlcklPLkVsZW1lbnQ+LFxuICAgICAgICBwcml2YXRlIF9wYXJlbnRFbGVtPzogc3RyaW5nIHwgQ2hhaW5hYmxlUHJvbWlzZUVsZW1lbnQ8V2ViZHJpdmVySU8uRWxlbWVudD5cbiAgICApIHt9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxvY2F0b3IgbWFwIG9mIGdpdmVuIHBhZ2Ugb2JqZWN0XG4gICAgICovXG4gICAgZ2V0IGxvY2F0b3JzICgpIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5sb2NhdG9yS2V5KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRvcktleS5yZWR1Y2UoKHByZXYsIGxvY2F0b3JLZXkpID0+ICh7XG4gICAgICAgICAgICAgICAgLi4ucHJldixcbiAgICAgICAgICAgICAgICAuLi50aGlzLl9sb2NhdG9yc1tsb2NhdG9yS2V5XVxuICAgICAgICAgICAgfSBhcyBMb2NhdG9ycyksIHt9IGFzIExvY2F0b3JzKSBhcyBhbnkgYXMgUGFnZUxvY2F0b3JzXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2xvY2F0b3JzW3RoaXMubG9jYXRvcktleV0gYXMgYW55IGFzIFBhZ2VMb2NhdG9yc1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgZ2V0IGJhc2VFbGVtICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Jhc2VFbGVtXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBnZXQgbG9jYXRvck1hcCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sb2NhdG9yc1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJhc2UgZWxlbWVudCBvZiBnaXZlbiBwYWdlIG9iamVjdFxuICAgICAqL1xuICAgIGdldCBlbGVtICgpIHtcbiAgICAgICAgY29uc3QgYmFzZUxvY2F0b3IgPSAodGhpcy5sb2NhdG9ycyBhcyBhbnkgYXMgTG9jYXRvcnMpLmVsZW1cbiAgICAgICAgaWYgKHRoaXMuX2Jhc2VFbGVtKSB7XG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIHRoaXMuX2Jhc2VFbGVtID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgICAgID8gYnJvd3Nlci4kKHRoaXMuX2Jhc2VFbGVtKVxuICAgICAgICAgICAgICAgIDogdGhpcy5fYmFzZUVsZW1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgYmFzZUxvY2F0b3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gYnJvd3Nlci4kKGJhc2VMb2NhdG9yKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGJyb3dzZXIuJCgnaHRtbCcpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyZW50IGVsZW1lbnQgb2YgZ2l2ZW4gcGFnZSBvYmplY3RcbiAgICAgKi9cbiAgICBnZXQgcGFyZW50ICgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3BhcmVudEVsZW0pIHtcbiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdGhpcy5fcGFyZW50RWxlbSA9PT0gJ3N0cmluZydcbiAgICAgICAgICAgICAgICA/IGJyb3dzZXIuJCh0aGlzLl9wYXJlbnRFbGVtKVxuICAgICAgICAgICAgICAgIDogdGhpcy5fcGFyZW50RWxlbVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBicm93c2VyLiQoJ2h0bWwnKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgc2V0UGFyZW50RWxlbWVudCAocGFyZW50RWxlbTogc3RyaW5nIHwgQ2hhaW5hYmxlUHJvbWlzZUVsZW1lbnQ8V2ViZHJpdmVySU8uRWxlbWVudD4pIHtcbiAgICAgICAgdGhpcy5fcGFyZW50RWxlbSA9IHBhcmVudEVsZW1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXYWl0IGZvciB0aGUgZWxlbWVudCB0byBiZWNvbWUgdmlzaWJsZVxuICAgICAqIEBwYXJhbSB0aW1lb3V0IGN1c3RvbSB0aW1lb3V0IGZvciB0aGUgd2FpdFxuICAgICAqIEByZXR1cm5zIHRoZW5hYmxlIHNlbGYgcmVmZXJlbmNlXG4gICAgICovXG4gICAgYXN5bmMgd2FpdCAodGltZW91dCA9IDUwMDApOiBQcm9taXNlPHRoaXM+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5lbGVtLndhaXRGb3JEaXNwbGF5ZWQoeyB0aW1lb3V0IH0pXG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9sbCBmb3IgdGhlIGVsZW1lbnQgdG8gYmVjb21lIHZpc2libGVcbiAgICAgKiBAcGFyYW0gdGltZW91dCBjdXN0b20gdGltZW91dCBmb3IgdGhlIHdhaXRcbiAgICAgKiBAcGFyYW0gaW50ZXJ2YWwgY3VzdG9tIGludGVydmFsIHRvIGNvbnRyb2wgcG9sbGluZ1xuICAgICAqIEByZXR1cm5zIHRoZW5hYmxlIHNlbGYgcmVmZXJlbmNlXG4gICAgICovXG4gICAgYXN5bmMgcG9sbCAodGltZW91dCA9IDEwMDAwLCBpbnRlcnZhbCA9IDIwMDApOiBQcm9taXNlPHRoaXM+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5lbGVtLndhaXRGb3JEaXNwbGF5ZWQoeyB0aW1lb3V0LCBpbnRlcnZhbCB9KVxuICAgICAgICByZXR1cm4gdGhpc1xuICAgIH1cbn1cblxuLyoqXG4gKiBBYnN0cmFjdCBlbGVtZW50IHRoYXQgaGFzIGEgY29udGV4dCBtZW51XG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFbGVtZW50V2l0aENvbnRleHRNZW51PFQ+IGV4dGVuZHMgQmFzZVBhZ2U8VD4ge1xuICAgIC8qKlxuICAgICAqIE9wZW4gY29udGV4dCBtZW51IG9uIHRoZSBlbGVtZW50XG4gICAgICovXG4gICAgYXN5bmMgb3BlbkNvbnRleHRNZW51ICgpOiBQcm9taXNlPENvbnRleHRNZW51PiB7XG4gICAgICAgIGNvbnN0IGNvbnRleHRNZW51TG9jYXRvcnMgPSB0aGlzLmxvY2F0b3JNYXAuQ29udGV4dE1lbnUgYXMgQWxsTG9jYXRvclR5cGVbJ0NvbnRleHRNZW51J11cbiAgICAgICAgY29uc3Qgd29ya2JlbmNoID0gYnJvd3Nlci4kKCh0aGlzLmxvY2F0b3JNYXAuV29ya2JlbmNoIGFzIEFsbExvY2F0b3JUeXBlWydXb3JrYmVuY2gnXSkuZWxlbSlcbiAgICAgICAgY29uc3QgbWVudXMgPSBhd2FpdCBicm93c2VyLiQkKGNvbnRleHRNZW51TG9jYXRvcnMuY29udGV4dFZpZXcpXG5cbiAgICAgICAgaWYgKG1lbnVzLmxlbmd0aCA8IDEpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZWxlbS5jbGljayh7IGJ1dHRvbjogMiB9KVxuICAgICAgICAgICAgYXdhaXQgYnJvd3Nlci4kKGNvbnRleHRNZW51TG9jYXRvcnMuY29udGV4dFZpZXcpLndhaXRGb3JFeGlzdCh7IHRpbWVvdXQ6IDIwMDAgfSlcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29udGV4dE1lbnUodGhpcy5sb2NhdG9yTWFwLCB3b3JrYmVuY2gpLndhaXQoKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGF3YWl0IHdvcmtiZW5jaC4kJChjb250ZXh0TWVudUxvY2F0b3JzLnZpZXdCbG9jaykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbGVtLmNsaWNrKHsgYnV0dG9uOiAyIH0pXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVsZW0ud2FpdEZvckRpc3BsYXllZCh7IHJldmVyc2U6IHRydWUsIHRpbWVvdXQ6IDEwMDAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuZWxlbS5jbGljayh7IGJ1dHRvbjogMiB9KVxuICAgICAgICByZXR1cm4gbmV3IENvbnRleHRNZW51KHRoaXMubG9jYXRvck1hcCkud2FpdCgpXG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2xlZXAgKG1zID0gNTAwKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXMpID0+IHtcbiAgICAgICAgc2V0VGltZW91dChyZXMsIG1zKVxuICAgIH0pXG59XG4iXX0=